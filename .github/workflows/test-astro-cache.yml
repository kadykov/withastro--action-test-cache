name: Test Astro Cache Feature

# Only run manually to test the cache feature
on:
  workflow_dispatch:

jobs:
  # Test 1: Basic cache functionality with two consecutive builds
  test-cache:
    name: Test cache creation and restoration
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: First build (cold cache) - using fork
        uses: kadykov/withastro--action@astro-cache
        with:
          node-version: "24"
          package-manager: "npm"
          cache: "true"

      - name: Check if Astro cache was created
        run: |
          echo "=== Checking for Astro cache directory ==="
          if [ -d "node_modules/.astro" ]; then
            echo "✓ Astro cache directory exists"
            echo "Cache contents:"
            ls -lah node_modules/.astro/ || true
            du -sh node_modules/.astro/ || true
          else
            echo "⚠ Astro cache directory not found (may be normal if no images were optimized)"
          fi

      - name: Check dist output
        run: |
          echo "=== Checking dist directory ==="
          if [ -d "dist" ]; then
            echo "✓ Build successful"
            du -sh dist/
            echo "Looking for optimized images:"
            find dist -name "*.webp" -o -name "*.avif" | head -10 || echo "No optimized images found"
          else
            echo "✗ Build failed - no dist directory"
            exit 1
          fi

      - name: Clean dist directory (keep cache)
        run: rm -rf dist

      - name: Second build (should restore cache)
        uses: kadykov/withastro--action@astro-cache
        with:
          node-version: "24"
          package-manager: "npm"
          cache: "true"

      - name: Verify second build
        run: |
          echo "=== Verifying second build ==="
          if [ -d "dist" ]; then
            echo "✓ Second build successful with cache"
            du -sh dist/
          else
            echo "✗ Second build failed"
            exit 1
          fi

  # Test 2: Verify cache can be disabled
  # This runs AFTER test-cache to avoid cache conflicts
  test-cache-disabled:
    name: Test with cache disabled
    runs-on: ubuntu-latest
    needs: test-cache  # Run after test-cache completes
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Build with cache disabled
        uses: kadykov/withastro--action@astro-cache
        with:
          node-version: "24"
          package-manager: "npm"
          cache: "false"

      - name: Verify build succeeded
        run: |
          if [ -d "dist" ]; then
            echo "✓ Build successful with cache disabled"
            du -sh dist/
          else
            echo "✗ Build failed"
            exit 1
          fi

  # Test 3: Full production-like workflow with artifact upload
  # This runs LAST to avoid artifact naming conflicts
  test-production-workflow:
    name: Test production-like workflow
    runs-on: ubuntu-latest
    needs: test-cache-disabled  # Run after test-cache-disabled completes
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Build with caching (using fork)
        uses: kadykov/withastro--action@astro-cache
        with:
          node-version: "24"
          package-manager: "npm"
          cache: "true"

      - name: Verify github-pages artifact was created
        run: |
          echo "✓ Build completed successfully"
          echo "The action automatically creates a 'github-pages' artifact"
          echo "Check the workflow summary to see the artifact"

      - name: Additional verification (if needed)
        run: |
          if [ -d "dist" ]; then
            echo "✓ dist directory exists"
            echo "Size: $(du -sh dist | cut -f1)"
          fi
